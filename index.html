<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Laporan Produksi Gabungan</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f2f2f2; }
    .topbar { display:flex; background:#007bff; }
    .tabBtn { flex:1; padding:12px; border:0; background:#007bff; color:#fff; font-weight:bold; cursor:pointer; }
    .tabBtn.active { background:#0056b3; }
    .container { max-width:900px; margin:auto; padding:16px; }
    .tabContent { display:none; }
    .tabContent.active { display:block; }
    input,textarea,select,button { width:100%; padding:10px; margin-top:8px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; font-size:14px; }
    button { cursor:pointer; }
    button.primary { background:#28a745; color:#fff; border:0; }
    button.wa { background:#25d366; color:#fff; border:0; }
    button.blue { background:#007bff; color:#fff; border:0; }
    pre { background:#fff; padding:12px; border:1px solid #ddd; border-radius:6px; white-space:pre-wrap; }
    .notif { display:none; margin-top:8px; padding:8px; border-radius:6px; }
    .notif.ok { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
    .notif.err { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
    details { background:#fff; margin:8px 0; padding:8px; border-radius:6px; border:1px solid #ddd; }
    summary { font-weight:bold; cursor:pointer; }
  </style>
</head>
<body>

<!-- TAB BAR -->
<div class="topbar">
  <button class="tabBtn active" data-target="tabShift">Laporan Shift</button>
  <button class="tabBtn" data-target="tabLine23">Laporan Line 2 & 3</button>
  <button class="tabBtn" data-target="tabMonitor">Monitoring</button>
</div>

<div class="container">

  <!-- TAB 1: SHIFT -->
  <div id="tabShift" class="tabContent active">
    <h2>Laporan Shift</h2>
    <label>Tanggal</label>
    <input type="date" id="tanggal">
    <label>Shift</label>
    <select id="shiftSelect" onchange="updateShiftInput()">
      <option value="">-- Pilih Shift --</option>
      <option value="A">A</option>
      <option value="B">B</option>
      <option value="C">C</option>
      <option value="lain">Lainnya (manual)</option>
    </select>
    <input id="shift" placeholder="Isi shift manual" style="display:none">
    <input id="produk" placeholder="Produk">

    <h3>GRINDING</h3>
    <input id="psa" placeholder="PSA">
    <input id="mesh" placeholder="Mesh">
    <input id="mix_a" placeholder="Mix A">
    <input id="mix_b" placeholder="Mix B">
    <input id="silo_a" placeholder="Silo A">
    <input id="silo_b" placeholder="Silo B">
    <textarea id="catatan_grinding" placeholder="Catatan Grinding"></textarea>

    <h3>PREPARATION</h3>
    <input id="pulp203" placeholder="Pulp 203">
    <input id="pulp204" placeholder="Pulp 204">
    <input id="pulp205" placeholder="Pulp 205">
    <input id="adhesive_standby" placeholder="Adhesive Standby">
    <input id="adhesive_sisa" placeholder="Adhesive Sisa">
    <input id="flavor_standby" placeholder="Flavor Standby">
    <input id="flavor_sisa" placeholder="Flavor Sisa">
    <input id="kalsium" placeholder="Kalsium">
    <input id="recycle" placeholder="Recycle">
    <textarea id="catatan_preparation" placeholder="Catatan Preparation"></textarea>

    <h3>FINISH GOOD</h3>
    <input id="mr" placeholder="Mother Roll">
    <input id="fg_berat" placeholder="Berat (kg)">
    <textarea id="catatan_finish" placeholder="Catatan Finish"></textarea>

    <h3>CYLINDER</h3>
    <input id="pisau" placeholder="Pisau">
    <textarea id="catatan_cylinder" placeholder="Catatan Cylinder"></textarea>

    <h3>SLITTING</h3>
    <input id="slit_mr" placeholder="Slit MR">
    <input id="reject_produksi" placeholder="Reject Produksi">
    <input id="reject_ncp" placeholder="Reject NCP">
    <input id="total_bobin_manual" placeholder="Total Bobin Manual">
    <textarea id="catatan_slitting" placeholder="Catatan Slitting"></textarea>

    <button class="primary" onclick="generateAndSaveShift()">Simpan Shift</button>
    <div id="notifShift" class="notif"></div>
    <pre id="outputShift"></pre>
    <button class="wa" onclick="sendOutputWhatsApp('outputShift')">Kirim WA</button>
    <button class="blue" onclick="copyOutput('outputShift')">Salin</button>
  </div>

  <!-- TAB 2: LINE 2 & 3 (pakai file asli) -->
  <div id="tabLine23" class="tabContent">
    <h2>Laporan Line 2 & 3</h2>
    <label>Tanggal</label>
    <input type="date" id="tanggal2">
    <input id="shift2" placeholder="Shift">
    <input id="produk2" placeholder="Produk">

    <h3>LINE 2</h3>
    <label>Pulp Tank 205</label><input id="pulp205_2">
    <label>Vitacel Mix A</label><input id="vit2a">
    <label>Vitacel Mix B</label><input id="vit2b">
    <label>Vitacel Standby</label><input id="vit2s">
    <label>Adhesive Standby</label><input id="adh2s">
    <label>Adhesive di Tangki</label><input id="adh2t">
    <label>CMC</label><input id="cmc2">
    <label>Recycle</label><input id="rec2">
    <label>Mother Roll Line2</label><input id="mr2">
    <label>Total Berat Line2 (kg)</label><input id="fg2">
    <label>Slit MR Line2</label><input id="slit_mr2">
    <label>Reject Produksi Line2</label><input id="reject_produksi2">
    <label>Reject NCP Line2</label><input id="reject_ncp2">
    <label>Total Bobin Manual Line2</label><input id="total_bobin_manual2">
    <textarea id="catatan2" placeholder="Catatan Line 2"></textarea>

    <h3>LINE 3</h3>
    <label>Pulp Tank 204</label><input id="pulp204_3">
    <label>Vitacel Mix A</label><input id="vit3a">
    <label>Vitacel Mix B</label><input id="vit3b">
    <label>Vitacel Standby</label><input id="vit3s">
    <label>Adhesive Standby</label><input id="adh3s">
    <label>Adhesive di Tangki</label><input id="adh3t">
    <label>CMC</label><input id="cmc3">
    <label>Recycle</label><input id="rec3">
    <label>Mother Roll Line3</label><input id="mr3">
    <label>Total Berat Line3 (kg)</label><input id="fg3">
    <label>Slit MR Line3</label><input id="slit_mr3">
    <label>Reject Produksi Line3</label><input id="reject_produksi3">
    <label>Reject NCP Line3</label><input id="reject_ncp3">
    <label>Total Bobin Manual Line3</label><input id="total_bobin_manual3">
    <textarea id="catatan3" placeholder="Catatan Line 3"></textarea>

    <button class="primary" onclick="generateAndSaveLine23()">Simpan Line 2&3</button>
    <div id="notifLine" class="notif"></div>
    <pre id="outputLine23"></pre>
    <button class="wa" onclick="sendOutputWhatsApp('outputLine23')">Kirim WA</button>
    <button class="blue" onclick="copyOutput('outputLine23')">Salin</button>
  </div>

  <!-- TAB 3: MONITORING -->
  <div id="tabMonitor" class="tabContent">
    <h2>Monitoring Gabungan</h2>
    <label>Filter Tanggal</label><input type="date" id="monitorTanggal" onchange="renderMonitor()">
    <div id="monitorOutput"></div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCReZ1Hs1p63Sq6DWODvwbKCgpVPUzVKQA",
  authDomain: "laporanharian-d689c.firebaseapp.com",
  databaseURL: "https://laporanharian-d689c-default-rtdb.firebaseio.com",
  projectId: "laporanharian-d689c",
  storageBucket: "laporanharian-d689c.appspot.com",
  messagingSenderId: "161606001787",
  appId: "1:161606001787:web:a2550a1abf208ce188aede",
  measurementId: "G-E9SL4RT4TB"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* Tab navigation */
document.querySelectorAll('.tabBtn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tabBtn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tabContent').forEach(c=>c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.target).classList.add('active');
  });
});

function val(id){ return document.getElementById(id)?.value.trim() || ""; }
function showNotif(id,msg,ok){ const n=document.getElementById(id); n.textContent=msg; n.className="notif "+(ok?"ok":"err"); n.style.display="block"; setTimeout(()=>n.style.display="none",3000);}
function sendOutputWhatsApp(id){ const txt=document.getElementById(id).textContent; if(txt) window.open("https://wa.me/?text="+encodeURIComponent(txt),"_blank"); }
function copyOutput(id){ const txt=document.getElementById(id).textContent; navigator.clipboard.writeText(txt); alert("Laporan disalin!"); }
window.updateShiftInput=function(){ const s=document.getElementById("shiftSelect"); const i=document.getElementById("shift"); i.style.display=s.value==="lain"?"block":"none"; i.value=s.value==="lain"?"":s.value; };

/* SHIFT */
window.generateAndSaveShift=function(){
  const laporan=`LAPORAN SHIFT ${val("shift")}\nTanggal:${val("tanggal")}\nProduk:${val("produk")}`;
  document.getElementById("outputShift").textContent=laporan;
  const refDb=ref(db,"laporan_shift/"+(val("tanggal")||"tanpa_tanggal"));
  const newRef=push(refDb);
  set(newRef,{shift:val("shift"),laporan, waktu:new Date().toISOString()})
   .then(()=>showNotif("notifShift","✅ Tersimpan",true))
   .catch(()=>showNotif("notifShift","❌ Gagal",false));
};

/* LINE 2 & 3 */
window.generateAndSaveLine23=function(){
  const laporan=`LAPORAN LINE 2&3\nTanggal:${val("tanggal2")}\nShift:${val("shift2")}\nProduk:${val("produk2")}`;
  document.getElementById("outputLine23").textContent=laporan;
  const refDb=ref(db,"laporan_line2_3/"+(val("tanggal2")||"tanpa_tanggal"));
  const newRef=push(refDb);
  set(newRef,{shift:val("shift2"),laporan,waktu:new Date().toISOString()})
   .then(()=>showNotif("notifLine","✅ Tersimpan",true))
   .catch(()=>showNotif("notifLine","❌ Gagal",false));
};

/* Monitoring gabungan */
let cachedShift={},cachedLine={};
onValue(ref(db,"laporan_shift"),snap=>{cachedShift=snap.val()||{}; renderMonitor();});
onValue(ref(db,"laporan_line2_3"),snap=>{cachedLine=snap.val()||{}; renderMonitor();});
window.renderMonitor=function(){
  const f=val("monitorTanggal");
  const out=document.getElementById("monitorOutput"); out.innerHTML="";
  function render(node,label){
    Object.keys(node).forEach(tgl=>{
      if(f && tgl!==f) return;
      Object.values(node[tgl]).forEach(item=>{
        const d=document.createElement("details");
        d.innerHTML=`<summary>${label} | ${tgl}</summary><pre>${item.laporan}</pre>
          <button onclick="window.open('https://wa.me/?text=${encodeURIComponent(item.laporan)}')">WA</button>
          <button onclick="navigator.clipboard.writeText(\`${item.laporan}\`)">Salin</button>`;
        out.appendChild(d);
      });
    });
  }
  render(cachedShift,"Shift");
  render(cachedLine,"Line2&3");
};
</script>

</body>
</html>
