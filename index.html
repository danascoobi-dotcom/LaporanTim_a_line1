<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Aplikasi Laporan Produksi</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f5f5f5;margin:0}
    .topbar{display:flex;background:#007bff}
    .tabBtn{flex:1;padding:12px;border:0;background:#007bff;color:#fff;font-weight:bold;cursor:pointer}
    .tabBtn.active{background:#0056b3}
    .container{max-width:920px;margin:auto;padding:16px}
    .tabContent{display:none}
    .tabContent.active{display:block}
    input,textarea,select,button{width:100%;padding:10px;margin-top:6px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;font-size:14px}
    textarea{resize:vertical;min-height:60px}
    label{font-weight:bold;margin-top:8px;display:block}
    button.primary{background:#28a745;color:#fff;border:0;margin-top:8px}
    button.wa{background:#25d366;color:#fff;border:0;margin-top:8px}
    button.blue{background:#007bff;color:#fff;border:0;margin-top:8px}
    pre{background:#fff;border:1px solid #ddd;border-radius:6px;padding:12px;white-space:pre-wrap}
    .notif{display:none;padding:8px;margin-top:8px;border-radius:6px}
    .notif.ok{background:#d4edda;color:#155724}
    .notif.err{background:#f8d7da;color:#721c24}
    details{background:#fff;padding:8px;border:1px solid #ddd;border-radius:6px;margin:6px 0}
    summary{font-weight:bold;cursor:pointer}
    .small{font-size:12px;color:#555}
  </style>
</head>
<body>

<div class="topbar">
  <button class="tabBtn active" data-target="line1">Laporan Line 1</button>
  <button class="tabBtn" data-target="line23">Laporan Line 2 & 3</button>
  <button class="tabBtn" data-target="monitor">Data Server Laporan</button>
</div>

<div class="container">

  <!-- TAB 1: LAPORAN LINE 1 -->
  <div id="line1" class="tabContent active">
    <h2>Laporan Line 1 (Shift)</h2>
    <label>Tanggal</label><input type="date" id="tgl1">
    <label>Shift</label><input id="shift1" placeholder="Shift A/B/C">
    <label>Produk</label><input id="produk1">

    <h3>Grinding</h3>
    <input id="psa1" placeholder="Ukuran PSA / Partikel">
    <input id="mesh1" placeholder="Mesh">
    <input id="mix_a1" placeholder="Mix A">
    <input id="mix_b1" placeholder="Mix B">
    <input id="silo_a1" placeholder="Silo A">
    <input id="silo_b1" placeholder="Silo B">
    <textarea id="catatan_grinding1" placeholder="Catatan Grinding"></textarea>

    <h3>Preparation</h3>
    <input id="pulp203_1" placeholder="Pulp 203">
    <input id="pulp204_1" placeholder="Pulp 204">
    <input id="pulp205_1" placeholder="Pulp 205">
    <input id="adhesive_standby1" placeholder="Adhesive Standby">
    <input id="adhesive_sisa1" placeholder="Adhesive Sisa">
    <input id="flavor_standby1" placeholder="Flavor Standby">
    <input id="flavor_sisa1" placeholder="Flavor Sisa">
    <input id="kalsium1" placeholder="Kalsium">
    <input id="recycle1" placeholder="Recycle">
    <textarea id="catatan_prep1" placeholder="Catatan Preparation"></textarea>

    <h3>Finish Good</h3>
    <input id="mr1" placeholder="Mother Roll">
    <input id="fg_berat1" placeholder="Berat (kg)">
    <textarea id="catatan_finish1" placeholder="Catatan Finish Good"></textarea>

    <h3>Cylinder</h3>
    <input id="pisau1" placeholder="Pisau Nomor">
    <textarea id="catatan_cyl1" placeholder="Catatan Cylinder"></textarea>

    <h3>Slitting</h3>
    <input id="slit_mr1" placeholder="Slitting MR">
    <input id="reject_prod1" placeholder="Reject Produksi">
    <input id="reject_ncp1" placeholder="Reject NCP">
    <input id="total_bobin1" placeholder="Total Bobin Manual">
    <textarea id="catatan_slit1" placeholder="Catatan Slitting"></textarea>

    <button class="primary" onclick="saveLine1()">Simpan Laporan Line 1</button>
    <div id="notif1" class="notif"></div>
    <pre id="out1"></pre>
    <button class="wa" onclick="sendWA('out1')">Kirim WhatsApp</button>
    <button class="blue" onclick="copyText('out1')">Salin</button>
  </div>

  <!-- TAB 2: LAPORAN LINE 2 & 3 (pakai file asli, tidak diubah) -->
  <div id="line23" class="tabContent">
    <h2>Laporan Line 2 & 3</h2>
    <label>Tanggal</label><input type="date" id="tgl2">
    <label>Shift</label><input id="shift2" placeholder="Shift">
    <input id="produk2" placeholder="Produk">

    <h3>Line 2</h3>
    <label>Pulp Tank 205</label><input id="pulp205_2">
    <label>Vitacel Mix A</label><input id="vit2a">
    <label>Vitacel Mix B</label><input id="vit2b">
    <label>Vitacel Standby</label><input id="vit2s">
    <label>Adhesive Standby</label><input id="adh2s">
    <label>Adhesive di Tangki</label><input id="adh2t">
    <label>CMC</label><input id="cmc2">
    <label>Recycle</label><input id="rec2">
    <label>Mother Roll Line 2</label><input id="mr2">
    <label>Total Berat Line 2 (kg)</label><input id="fg2">
    <label>Slitting MR Line 2</label><input id="slit2">
    <label>Reject Produksi Line 2</label><input id="rej2a">
    <label>Reject NCP Line 2</label><input id="rej2b">
    <label>Total Bobin Manual Line 2</label><input id="bob2">
    <label>Catatan Line 2</label><textarea id="cat2"></textarea>

    <h3>Line 3</h3>
    <label>Pulp Tank 204</label><input id="pulp204_3">
    <label>Vitacel Mix A</label><input id="vit3a">
    <label>Vitacel Mix B</label><input id="vit3b">
    <label>Vitacel Standby</label><input id="vit3s">
    <label>Adhesive Standby</label><input id="adh3s">
    <label>Adhesive di Tangki</label><input id="adh3t">
    <label>CMC</label><input id="cmc3">
    <label>Recycle</label><input id="rec3">
    <label>Mother Roll Line 3</label><input id="mr3">
    <label>Total Berat Line 3 (kg)</label><input id="fg3">
    <label>Slitting MR Line 3</label><input id="slit3">
    <label>Reject Produksi Line 3</label><input id="rej3a">
    <label>Reject NCP Line 3</label><input id="rej3b">
    <label>Total Bobin Manual Line 3</label><input id="bob3">
    <label>Catatan Line 3</label><textarea id="cat3"></textarea>

    <button class="primary" onclick="saveLine23()">Simpan Laporan Line 2&3</button>
    <div id="notif2" class="notif"></div>
    <pre id="out2"></pre>
    <button class="wa" onclick="sendWA('out2')">Kirim WhatsApp</button>
    <button class="blue" onclick="copyText('out2')">Salin</button>
  </div>

  <!-- TAB 3: DATA SERVER -->
  <div id="monitor" class="tabContent">
    <h2>Data Server Laporan</h2>
    <label>Filter Tanggal</label><input type="date" id="fltDate" onchange="renderData()">
    <div id="dataOut"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCReZ1Hs1p63Sq6DWODvwbKCgpVPUzVKQA",
  authDomain: "laporanharian-d689c.firebaseapp.com",
  databaseURL: "https://laporanharian-d689c-default-rtdb.firebaseio.com",
  projectId: "laporanharian-d689c",
  storageBucket: "laporanharian-d689c.appspot.com",
  messagingSenderId: "161606001787",
  appId: "1:161606001787:web:a2550a1abf208ce188aede"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Helper
function val(id){return document.getElementById(id).value.trim();}
function showNotif(id,msg,ok){const n=document.getElementById(id);n.textContent=msg;n.className="notif "+(ok?"ok":"err");n.style.display="block";setTimeout(()=>n.style.display="none",3000);}
function sendWA(id){const txt=document.getElementById(id).textContent;if(txt) window.open("https://wa.me/?text="+encodeURIComponent(txt),"_blank");}
function copyText(id){const txt=document.getElementById(id).textContent;navigator.clipboard.writeText(txt);alert("Disalin!");}
document.querySelectorAll('.tabBtn').forEach(btn=>{btn.onclick=()=>{document.querySelectorAll('.tabBtn').forEach(b=>b.classList.remove('active'));document.querySelectorAll('.tabContent').forEach(c=>c.classList.remove('active'));btn.classList.add('active');document.getElementById(btn.dataset.target).classList.add('active');};});

// Save Line 1
window.saveLine1=function(){
  const laporan=`LAPORAN LINE 1
Tanggal:${val("tgl1")} 
Shift:${val("shift1")} 
Produk:${val("produk1")}`;
  document.getElementById("out1").textContent=laporan;
  const refDb=ref(db,"laporan_line1/"+(val("tgl1")||"tanpa_tanggal"));
  const newRef=push(refDb);
  set(newRef,{shift:val("shift1"),laporan,waktu:new Date().toISOString()})
   .then(()=>showNotif("notif1","✅ Tersimpan",true))
   .catch(()=>showNotif("notif1","❌ Gagal",false));
};

// Save Line 2&3
window.saveLine23=function(){
  const laporan=`LAPORAN LINE 2&3
Tanggal:${val("tgl2")} 
Shift:${val("shift2")} 
Produk:${val("produk2")}`;
  document.getElementById("out2").textContent=laporan;
  const refDb=ref(db,"laporan_line23/"+(val("tgl2")||"tanpa_tanggal"));
  const newRef=push(refDb);
  set(newRef,{shift:val("shift2"),laporan,waktu:new Date().toISOString()})
   .then(()=>showNotif("notif2","✅ Tersimpan",true))
   .catch(()=>showNotif("notif2","❌ Gagal",false));
};

// Monitoring
let cache1={},cache23={};
onValue(ref(db,"laporan_line1"),s=>{cache1=s.val()||{};renderData();});
onValue(ref(db,"laporan_line23"),s=>{cache23=s.val()||{};renderData();});

window.renderData=function(){
  const f=document.getElementById("fltDate").value;
  const out=document.getElementById("dataOut"); out.innerHTML="";
  function render(node,label){
    Object.keys(node).forEach(tgl=>{
      if(f && tgl!==f) return;
      const wrap=document.createElement("details");
      wrap.innerHTML=`<summary>${label} - ${tgl}</summary>`;
      Object.values(node[tgl]).forEach(item=>{
        const d=document.createElement("div");
        d.innerHTML=`<pre>${item.laporan}</pre><div class="small">${item.shift||"-"} | ${item.waktu}</div>
        <button class="wa" onclick="window.open('https://wa.me/?text='+encodeURIComponent(\`${item.laporan}\`))">WA</button>
        <button class="blue" onclick="navigator.clipboard.writeText(\`${item.laporan}\`)">Salin</button>`;
        wrap.appendChild(d);
      });
      out.appendChild(wrap);
    });
  }
  render(cache1,"Line 1");
  render(cache23,"Line 2&3");
};
</script>

</body>
</html>
