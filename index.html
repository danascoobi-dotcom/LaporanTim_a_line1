<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Laporan Shift</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; background: #f2f2f2; max-width: 700px; margin: auto; }
    input, textarea, button, select {
      width: 100%; padding: 10px; margin-top: 10px; font-size: 14px;
      border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box;
    }
    button { font-weight: bold; border: none; color: white; cursor: pointer; margin-top: 5px; }
    #generateBtn { background: #28a745; }
    #waBtn { background: #25d366; }
    #copyBtn { background: #007bff; }
    #hapusBtn { background: #dc3545; }
    pre {
      background: #fff; padding: 12px; border-radius: 5px; border: 1px solid #ccc;
      white-space: pre-wrap; font-family: monospace;
    }
    #listLaporan ul { list-style: none; padding-left: 10px; }
    #listLaporan li { margin-bottom: 10px; }
    #notif {
      margin-top: 10px; padding: 8px; border-radius: 5px; font-size: 14px;
      display: none;
    }
    #notif.sukses { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    #notif.gagal { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
  </style>
</head>
<body>

<h2>Input Laporan Produksi</h2>
<input type="date" id="tanggal">

<label for="shift">Pilih Shift:</label>
<select id="shiftSelect" onchange="updateShiftInput()">
  <option value="">-- Pilih Shift --</option>
  <option value="A">Shift A</option>
  <option value="B">Shift B</option>
  <option value="C">Shift C</option>
  <option value="lain">Lainnya (isi manual)</option>
</select>
<input id="shift" placeholder="Isi shift manual jika pilih 'Lainnya'">

<input id="produk" placeholder="Produk">

<h3>GRINDING</h3>
<input id="psa" placeholder="Ukuran PSA / Partikel">
<input id="mesh" placeholder="Mesh">
<input id="mix_a" placeholder="Mix A">
<input id="mix_b" placeholder="Mix B">
<input id="silo_a" placeholder="Silo A">
<input id="silo_b" placeholder="Silo B">
<textarea id="catatan_grinding" placeholder="Catatan Grinding..."></textarea>

<h3>PREPARATION</h3>
<input type="number" id="pulp203" placeholder="Pulp Tangki 203 (set)">
<input type="number" id="pulp204" placeholder="Pulp Tangki 204 (set)">
<input type="number" id="pulp205" placeholder="Pulp Tangki 205 (set)">
<input type="number" id="adhesive_standby" placeholder="Adhesive Standby (set)">
<input type="number" id="adhesive_sisa" placeholder="Adhesive Sisa (set)">
<input type="number" id="flavor_standby" placeholder="Flavor Standby (set)">
<input type="number" id="flavor_sisa" placeholder="Flavor Sisa (set)">
<input type="number" id="kalsium" placeholder="Kalsium Standby (set)">
<input id="recycle" placeholder="Recycle (mis. 3 set × 20 kg = 60 kg)">
<textarea id="catatan_preparation" placeholder="Catatan Preparation..."></textarea>

<h3>FINISH GOOD</h3>
<input type="number" id="mr" placeholder="Jumlah Mother Roll (roll)">
<input type="number" id="fg_berat" placeholder="Total Berat (kg)">
<textarea id="catatan_finish" placeholder="Catatan Finish Good..."></textarea>

<h3>CYLINDER</h3>
<input id="pisau" placeholder="Pisau Nomor">
<textarea id="catatan_cylinder" placeholder="Catatan Cylinder..."></textarea>

<h3>SLITTING</h3>
<input type="number" id="slit_mr" placeholder="Jumlah MR yang dipotong">
<input type="number" id="reject_produksi" placeholder="Bobin Reject Produksi">
<input type="number" id="reject_ncp" placeholder="Bobin Reject NCP">
<textarea id="catatan_slitting" placeholder="Catatan Slitting..."></textarea>

<button id="generateBtn" onclick="generate()">Tampilkan Laporan (Auto Save)</button>
<div id="notif"></div>
<pre id="output"></pre>
<button id="waBtn" onclick="kirimWhatsApp()">Kirim ke WhatsApp</button>
<button id="copyBtn" onclick="salinLaporan()">Salin Laporan</button>

<hr>
<div id="listLaporan" style="margin-top:20px; padding:10px; background:#fff; border-radius:8px;">
  <h3>📋 Data Laporan Realtime</h3>

  <label>Filter tanggal:</label>
  <input type="date" id="filterTanggal" onchange="tampilkanLaporan()">

  <label>Filter shift:</label>
  <select id="filterShift" onchange="tampilkanLaporan()">
    <option value="">Semua</option>
    <option value="A">Shift A</option>
    <option value="B">Shift B</option>
    <option value="C">Shift C</option>
  </select>

  <ul id="laporanList"></ul>
</div>

<script>
function g(id) { return document.getElementById(id).value.trim(); }
function n(id) { return parseInt(g(id)) || 0; }

function showNotif(pesan, sukses = true) {
  const notif = document.getElementById("notif");
  notif.textContent = pesan;
  notif.className = sukses ? "sukses" : "gagal";
  notif.style.display = "block";
  setTimeout(() => notif.style.display = "none", 3000);
}

function updateShiftInput() {
  const select = document.getElementById("shiftSelect");
  const input = document.getElementById("shift");
  if (select.value === "lain") {
    input.style.display = "block";
    input.value = "";
  } else {
    input.style.display = "none";
    input.value = select.value;
  }
}

function kirimWhatsApp() {
  const isi = document.getElementById("output").textContent;
  if (isi) {
    const url = "https://wa.me/?text=" + encodeURIComponent(isi);
    window.open(url, "_blank");
  }
}

function salinLaporan() {
  const isi = document.getElementById("output").textContent;
  if (isi) {
    navigator.clipboard.writeText(isi).then(() => {
      showNotif("📋 Laporan disalin ke clipboard", true);
    });
  }
}
</script>

<!-- 🔹 Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCReZ1Hs1p63Sq6DWODvwbKCgpVPUzVKQA",
    authDomain: "laporanharian-d689c.firebaseapp.com",
    databaseURL: "https://laporanharian-d689c-default-rtdb.firebaseio.com",
    projectId: "laporanharian-d689c",
    storageBucket: "laporanharian-d689c.appspot.com",
    messagingSenderId: "161606001787",
    appId: "1:161606001787:web:a2550a1abf208ce188aede",
    measurementId: "G-E9SL4RT4TB"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let semuaData = {};

  window.generate = function() {
    const shift = g("shift") || "-";
    let hasil = `LAPORAN SHIFT ${shift}\n`;
    if (g("tanggal")) hasil += `Tanggal: ${g("tanggal")}\n`;
    if (g("produk")) hasil += `Produk: ${g("produk")}\n\n`;

    // GRINDING
    let grinding = "";
    if (g("psa")) grinding += `- PSA: ${g("psa")} µm\n`;
    if (g("mesh")) grinding += `- Mesh: ${g("mesh")} mesh\n`;
    if (g("mix_a")) grinding += `- Mix A: ${g("mix_a")}\n`;
    if (g("mix_b")) grinding += `- Mix B: ${g("mix_b")}\n`;
    if (g("silo_a")) grinding += `- Silo A: ${g("silo_a")}\n`;
    if (g("silo_b")) grinding += `- Silo B: ${g("silo_b")}\n`;
    if (g("catatan_grinding")) grinding += g("catatan_grinding") + "\n";
    if (grinding) hasil += "GRINDING\n" + grinding + "\n";

    // PREPARATION
    let prep = "";
    if (g("pulp203")) prep += `- Pulp 203: ${g("pulp203")}\n`;
    if (g("pulp204")) prep += `- Pulp 204: ${g("pulp204")}\n`;
    if (g("pulp205")) prep += `- Pulp 205: ${g("pulp205")}\n`;
    if (g("adhesive_standby")) prep += `- Adhesive Standby: ${g("adhesive_standby")}\n`;
    if (g("adhesive_sisa")) prep += `- Adhesive Sisa: ${g("adhesive_sisa")}\n`;
    if (g("flavor_standby")) prep += `- Flavor Standby: ${g("flavor_standby")}\n`;
    if (g("flavor_sisa")) prep += `- Flavor Sisa: ${g("flavor_sisa")}\n`;
    if (g("kalsium")) prep += `- Kalsium: ${g("kalsium")}\n`;
    if (g("recycle")) prep += `- Recycle: ${g("recycle")}\n`;
    if (g("catatan_preparation")) prep += g("catatan_preparation") + "\n";
    if (prep) hasil += "PREPARATION\n" + prep + "\n";

    // FINISH GOOD
    let finish = "";
    if (g("mr")) finish += `- Mother Roll: ${g("mr")}\n`;
    if (g("fg_berat")) finish += `- Berat: ${g("fg_berat")} kg\n`;
    if (g("catatan_finish")) finish += g("catatan_finish") + "\n";
    if (finish) hasil += "FINISH GOOD\n" + finish + "\n";

    // CYLINDER
    let cyl = "";
    if (g("pisau")) cyl += `- Pisau: ${g("pisau")}\n`;
    if (g("catatan_cylinder")) cyl += g("catatan_cylinder") + "\n";
    if (cyl) hasil += "CYLINDER\n" + cyl + "\n";

    // SLITTING
    let slit = "";
    if (g("slit_mr")) {
      const mr = parseFloat(g("slit_mr")) || 0;
      const rejectProduksi = parseFloat(g("reject_produksi")) || 0;
      const rejectNCP = parseFloat(g("reject_ncp")) || 0;

      const totalBobin = mr * 10;
      const totalKg = totalBobin * 15;
      slit += `- MR dipotong: ${mr} MR → ${totalBobin} bobin → ${totalKg} kg\n`;

      if (rejectProduksi > 0) slit += `- Reject Produksi: ${rejectProduksi} bobin\n`;
      if (rejectNCP > 0) slit += `- Reject NCP: ${rejectNCP} bobin\n`;

      const totalBobinOke = totalBobin - (rejectProduksi + rejectNCP);
      const totalKgOke = totalBobinOke * 15;
      slit += `- Total Bobin Oke: ${totalBobinOke} bobin → ${totalKgOke} kg\n`;
    }
    if (g("catatan_slitting")) slit += g("catatan_slitting") + "\n";
    if (slit) hasil += "SLITTING\n" + slit + "\n";

    document.getElementById("output").textContent = hasil;

    const tanggal = g("tanggal") || new Date().toISOString().slice(0,10);
    const laporanRef = ref(db, "laporan/" + tanggal);
    const newLaporan = push(laporanRef);
    set(newLaporan, {
      shift: shift,
      laporan: hasil,
      waktu: new Date().toISOString()
    })
    .then(() => showNotif("✅ Laporan berhasil disimpan!", true))
    .catch(() => showNotif("❌ Gagal menyimpan laporan!", false));
  };

  const laporanRef = ref(db, "laporan");
  onValue(laporanRef, (snapshot) => {
    semuaData = snapshot.val() || {};
    renderLaporan();
  });

  window.tampilkanLaporan = function() {
    renderLaporan();
  };

  window.hapusLaporan = function(tanggal, key) {
    const username = prompt("Masukkan Username:");
    const password = prompt("Masukkan Password:");
    if (username === "Tirta" && password === "Komunitas") {
      if (confirm("Yakin mau hapus laporan ini?")) {
        remove(ref(db, "laporan/" + tanggal + "/" + key));
      }
    } else {
      alert("❌ Username atau Password salah!");
    }
  };

  function renderLaporan() {
    const filterTanggal = document.getElementById("filterTanggal").value;
    const filterShift = document.getElementById("filterShift").value;
    const list = document.getElementById("laporanList");
    list.innerHTML = "";

    if (!semuaData || Object.keys(semuaData).length === 0) {
      list.innerHTML = "<li>Belum ada laporan tersimpan.</li>";
      return;
    }

    Object.keys(semuaData).forEach(tanggal => {
      if (filterTanggal && tanggal !== filterTanggal) return;
      const perTanggal = semuaData[tanggal];

      let isiTanggal = "";
      Object.keys(perTanggal).forEach(key => {
        const item = perTanggal[key];
        if (filterShift && item.shift !== filterShift) return;
        if (!item.laporan || item.laporan.toLowerCase().includes("tes laporan")) return;

        isiTanggal += `
          <li>
            <pre>${item.laporan}</pre>
            <small>Shift: ${item.shift || "-"} | ${item.waktu}</small><br>
            <button id="hapusBtn" onclick="hapusLaporan('${tanggal}','${key}')">Hapus</button>
          </li>`;
      });

      if (isiTanggal) {
        const liTanggal = document.createElement("li");
        liTanggal.innerHTML = `<b>${tanggal}</b><ul>${isiTanggal}</ul>`;
        list.appendChild(liTanggal);
      }
    });
  }
</script>

</body>
</html>
