<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Laporan Harian</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea { width: 100%; height: 80px; }
    button { margin-top: 5px; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
    pre { background: #f5f5f5; padding: 8px; border-radius: 6px; white-space: pre-wrap; }
    li { list-style: none; margin-bottom: 15px; }
    h3 { margin-top: 20px; }
    #loginBox { margin-bottom: 15px; }
  </style>
</head>
<body>

  <h2>Input Laporan</h2>
  <label>Shift:
    <select id="shift">
      <option value="">Pilih Shift</option>
      <option value="Pagi">Pagi</option>
      <option value="Sore">Sore</option>
      <option value="Malam">Malam</option>
    </select>
  </label>
  <br><br>
  <textarea id="laporan" placeholder="Tulis laporan di sini..."></textarea>
  <br>
  <button onclick="simpanLaporan()">Simpan</button>

  <hr>

  <div id="loginBox">
    <input type="password" id="adminPass" placeholder="Masukkan password admin">
    <button onclick="loginAdmin()">Login</button>
  </div>

  <h2>Daftar Laporan</h2>
  <div id="laporanContainer"></div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

    // TODO: ganti dengan konfigurasi Firebase milikmu
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT.firebaseio.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let isAdmin = false; // status login
    let lastSnapshot = null;

    function loginAdmin() {
      const pass = document.getElementById("adminPass").value;
      if (pass === "1234") { // ganti password admin
        isAdmin = true;
        alert("Login berhasil sebagai admin");
        renderLaporan(lastSnapshot); // render ulang supaya tombol muncul
      } else {
        alert("Password salah!");
      }
    }

    function simpanLaporan() {
      const shift = document.getElementById("shift").value;
      const laporan = document.getElementById("laporan").value.trim();
      if (!laporan) {
        alert("Laporan tidak boleh kosong!");
        return;
      }

      const tanggal = new Date().toISOString().slice(0,10);
      const newLaporan = push(ref(db, 'laporan/' + tanggal));

      set(newLaporan, {
        shift: shift || "-",
        laporan: laporan || "-",
        waktu: new Date().toISOString()
      });

      document.getElementById("laporan").value = "";
      alert("Laporan tersimpan!");
    }

    function renderLaporan(snapshot) {
      lastSnapshot = snapshot;
      const data = snapshot.val();
      const container = document.getElementById("laporanContainer");
      container.innerHTML = "";

      if (!data) return;

      Object.keys(data).forEach(tanggal => {
        let isiTanggal = "";
        const perTanggal = data[tanggal];

        Object.entries(perTanggal).forEach(([id, item]) => {
          if (!item.laporan) return;
          if (item.laporan.toLowerCase().includes("tes laporan")) return; // hide laporan test

          isiTanggal += `
            <li>
              <pre id="laporanText-${tanggal}-${id}">${item.laporan}</pre>
              <small id="laporanInfo-${tanggal}-${id}">Shift: ${item.shift || "-"} | ${item.waktu}</small><br>
              ${isAdmin ? `
                <button onclick="hapusLaporan('${tanggal}','${id}')">Hapus</button>
                <button onclick="editLaporan('${tanggal}','${id}','${item.shift}','${item.laporan.replace(/'/g, "\\'")}')">Edit</button>
              ` : ""}
            </li>`;
        });

        if (isiTanggal) {
          container.innerHTML += `
            <h3>${tanggal}</h3>
            <ul>${isiTanggal}</ul>`;
        }
      });
    }

    function hapusLaporan(tanggal, id) {
      if (!isAdmin) {
        alert("Harus login admin untuk hapus laporan!");
        return;
      }
      if (confirm("Yakin ingin hapus laporan ini?")) {
        remove(ref(db, 'laporan/' + tanggal + '/' + id));
      }
    }

    function editLaporan(tanggal, id, shift, laporan) {
      if (!isAdmin) {
        alert("Harus login admin untuk edit laporan!");
        return;
      }

      const newLaporan = prompt("Edit laporan:", laporan);
      if (newLaporan === null) return;

      const newShift = prompt("Edit shift (Pagi/Sore/Malam):", shift);
      if (newShift === null) return;

      update(ref(db, 'laporan/' + tanggal + '/' + id), {
        laporan: newLaporan || "-",
        shift: newShift || "-",
        waktu: new Date().toISOString()
      });
    }

    // realtime listener
    onValue(ref(db, 'laporan'), renderLaporan);
    
    // expose fungsi ke global
    window.simpanLaporan = simpanLaporan;
    window.loginAdmin = loginAdmin;
    window.hapusLaporan = hapusLaporan;
    window.editLaporan = editLaporan;
  </script>
</body>
</html>
